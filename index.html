<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flushing GI Scenario Analysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@100..900&display=swap" rel="stylesheet">
  <link href="css/index.css" rel="stylesheet" />
  <link href="css/district-panel.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="scroll-container">
    <!-- Screen 1: Landing Page -->
    <section class="screen" id="screen-map">
      <div class="dark-overlay"></div>
      <h1 class="title-overlay">Rain Garden Maintenance</h1>
      <div class="landing-buttons">
        <button class="landing-btn" onclick="document.getElementById('screen-combined-map').scrollIntoView({behavior: 'smooth'})">Environmental Context</button>
        <button class="landing-btn" onclick="document.getElementById('screen-scenario').scrollIntoView({behavior: 'smooth'})">Maintenance Impact Simulator</button>
        <button class="landing-btn" onclick="document.getElementById('about-modal').style.display='flex'">About</button>
      </div>
    </section>

    <!-- About Modal -->
    <div id="about-modal" class="about-modal">
      <div class="about-modal-content">
        <button class="about-modal-close" onclick="document.getElementById('about-modal').style.display='none'">&times;</button>
        <div class="about-modal-container">
          <!-- Left Column -->
          <div class="about-column about-left">
            <h2>About the Project</h2>
            <p>Rain gardens are small pieces of climate infrastructure but their impact depends on care.</p>
            <p>This project explores how street-level rain gardens across Queens help capture stormwater and reduce pressure on the sewer system and how their performance changes when routine maintenance is delayed.</p>
            <p>By combining environmental context with a simple maintenance simulation, the tool allows users to:</p>
            <ul>
              <li>see where rain gardens are located,</li>
              <li>understand the conditions they operate in,</li>
              <li>and explore how different maintenance scenarios affect stormwater capture at the neighborhood and district scale.</li>
            </ul>
            <p>The goal is not to predict exact outcomes, but to make the role of maintenance visible, comparable, and actionable for communities and decision-makers.</p>
          </div>
          
          <!-- Right Column -->
          <div class="about-column about-right">
            <h3>Data Sources</h3>
            
            <h4>Primary Infrastructure</h4>
            <p><strong>NYC Green Infrastructure (Rain Gardens)</strong><br>
            Location, asset ID, City Council District, Community District, and maintenance estimates</p>
            
            <h4>Administrative Boundaries</h4>
            <ul>
              <li>NYC City Council Districts</li>
              <li>NYC Community Districts</li>
            </ul>
            
            <h4>Environmental Context Layers</h4>
            <ul>
              <li>Soil classification (infiltration potential)</li>
              <li>Surface slope / elevation-derived slope</li>
            </ul>
            
            <h4>Model Parameters</h4>
            <ul>
              <li>Base rain garden capacity: 2,500 gallons (RAIN Coalition)</li>
              <li>Maintenance effort: approximately 3 to 4 hours per month per asset (RAIN Coalition)</li>
              <li>Performance degradation: 10% capacity loss per week without maintenance, capped at 20% minimum performance</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <section class="screen" id="screen-combined-map">
      <div id="map" class="map-container"></div>
      
      <!-- Control Panel Toggle Buttons (Upper Left) -->
      <div class="control-panel-buttons">
        <button class="control-btn" data-panel="layers">
          <span class="btn-text">Layers</span>
        </button>
        <button class="control-btn" data-panel="insights">
          <span class="btn-text">Explore Insights</span>
        </button>
      </div>

      <!-- Layer Management Panel (Upper Left - Collapsible) -->
      <div class="control-panel" id="layers-panel">
        <div class="panel-title">Layers</div>
        <ul id="layerList" class="layer-list">
          <li class="layer-item is-on" draggable="true" data-layer="gi-surface-dots">
            <span>GI Distribution</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="gi-surface-dots" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="gi-density-layer">
            <span>Density Map</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="gi-density-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="soils-layer">
            <span>Native Soils</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="soils-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="slope-layer">
            <span>Terrain Slope</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="slope-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="sewer-layer">
            <span>Sewer System</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="sewer-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="drainage-lines">
            <span>Sewer Drainage</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="drainage-lines" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="drainage-points">
            <span>Drainage Points</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider" data-layer="drainage-points" min="0" max="100" value="100">
            </div>
          </li>
        </ul>
        <p class="hint">Click to toggle. Drag to reorder.</p>
      </div>

      <!-- Insights Panel (Upper Left - Collapsible) -->
      <div class="control-panel" id="insights-panel">
        <div class="panel-title">Explore Insights</div>
        <div class="insights-buttons">
          <button class="insight-btn" data-insight="density">
            <div class="btn-icon">üìç</div>
            <div class="btn-label">Where are rain gardens concentrated?</div>
          </button>
          <button class="insight-btn" data-insight="soils">
            <div class="btn-icon">üå±</div>
            <div class="btn-label">Where are conditions favorable?</div>
          </button>
          <button class="insight-btn" data-insight="slope">
            <div class="btn-icon">‚õ∞Ô∏è</div>
            <div class="btn-label">Where might gardens struggle?</div>
          </button>
        </div>
      </div>

      <!-- GI Distribution Modal -->
      <div id="gi-modal" class="layer-modal">
        <h2 class="modal-title">Rain Garden Assets</h2>
        <div class="modal-content">
          <p>Rain garden and related green infrastructure assets. Larger circles indicate larger installations.</p>
          <div class="legend">
            <div class="legend-label">Asset Type</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #17A2B8; border-radius: 50%; border: 2px solid white;"></div>
              <span data-type="Rain Garden">Rain Garden</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #2ecc71; border-radius: 50%; border: 2px solid white;"></div>
              <span data-type="ROWRG">Rain Garden in Street</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #FFB366; border-radius: 50%; border: 2px solid white;"></div>
              <span data-type="ROWB">Bioswale (drainage)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #9B59B6; border-radius: 50%; border: 2px solid white;"></div>
              <span data-type="ROWGS">Green Street</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #E85D75; border-radius: 50%; border: 2px solid white;"></div>
              <span data-type="ROWSGS">Stormwater Green Street</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Density Modal -->
      <div id="density-modal" class="layer-modal">
        <h2 class="modal-title">Rain Garden Density in Queens</h2>
        <div class="modal-content">
          <p>Darker areas show concentrated rain garden clusters.</p>
          <div class="legend">
            <div class="legend-label">Gardens per Grid Cell</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #fce4ec;"></div>
              <span>1‚Äì4</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f8bbd0;"></div>
              <span>5‚Äì8</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f48fb1;"></div>
              <span>9‚Äì12</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f06292;"></div>
              <span>13‚Äì16</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ec407a;"></div>
              <span>17‚Äì20</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #e91e63;"></div>
              <span>21‚Äì24</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #d81b60;"></div>
              <span>25‚Äì28</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #c2185b;"></div>
              <span>29‚Äì32</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ad1457;"></div>
              <span>33‚Äì36</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #880e4f;"></div>
              <span>37+</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Soils Modal -->
      <div id="soils-modal" class="layer-modal">
        <h2 class="modal-title">Native Soil Conditions</h2>
        <div class="modal-content">
          <p>Better drainage = better for rain gardens. Hover for details.</p>
          <div class="legend">
            <div class="legend-label">Hydrologic Soil Group</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #1e7145;"></div>
              <span>Type A ‚Äî Best</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #2ecc71;"></div>
              <span>Type A/D ‚Äî Variable</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f4d03f;"></div>
              <span>Type B ‚Äî Good</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f8a028;"></div>
              <span>Type B/D ‚Äî Variable</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #e67e22;"></div>
              <span>Type C ‚Äî Fair</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #c0392b;"></div>
              <span>Type D ‚Äî Poor</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Slope Modal -->
      <div id="slope-modal" class="layer-modal">
        <h2 class="modal-title">Terrain Challenges</h2>
        <div class="modal-content">
          <p>Flat areas allow water to settle, steep slopes increase runoff.</p>
          <div class="legend">
            <div class="legend-label">Slope Range (%)</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #f0f8ff;"></div>
              <span>0‚Äì1.03</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #d4e9f7;"></div>
              <span>1.03‚Äì2.06</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #a8d4ed;"></div>
              <span>2.06‚Äì3.09</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #7cbde3;"></div>
              <span>3.09‚Äì4.12</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #50a8d9;"></div>
              <span>4.12‚Äì5.15</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #2493cf;"></div>
              <span>5.15‚Äì6.18</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #1578b8;"></div>
              <span>6.18‚Äì7.21</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #0f5fa1;"></div>
              <span>7.21‚Äì8.24</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #0a468a;"></div>
              <span>8.24‚Äì9.27</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #0c2340;"></div>
              <span>9.27+</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sewer System Modal -->
      <div id="sewer-modal" class="layer-modal">
        <h2 class="modal-title">Sewer System</h2>
        <div class="modal-content">
          <p>Shows the type of sewer infrastructure in each area.</p>
          <div class="legend">
            <div class="legend-label">System Type</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #2980b9;"></div>
              <span>Combined</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #e67e22;"></div>
              <span>Separat Combined</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #27ae60;"></div>
              <span>Direct Drainage</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #8e44ad;"></div>
              <span>Other</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #95a5a6;"></div>
              <span>Unknown</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sewer Drainage Modal -->
      <div id="drainage-lines-modal" class="layer-modal">
        <h2 class="modal-title">Sewer Drainage Areas</h2>
        <div class="modal-content">
          <p>Combined sewer drainage catchment areas showing stormwater flow paths.</p>
          <div class="legend">
            <div class="legend-label">Drainage Area</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ff6b6b; border: 1px solid #cc5555;"></div>
              <span>Drainage Polygon</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Drainage Points Modal -->
      <div id="drainage-points-modal" class="layer-modal">
        <h2 class="modal-title">Drainage Points</h2>
        <div class="modal-content">
          <p>Outfall and treatment points for stormwater systems. Circle size varies with zoom level.</p>
          <div class="legend">
            <div class="legend-label">Point Type</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #4ecdc4; border-radius: 50%; width: 16px; height: 16px; border: 2px solid white;"></div>
              <span>Drainage Point</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 3: Maintenance Explorer with Layers and Info Panel -->
    <section class="screen" id="screen-scenario">
      <!-- Layers Control Panel (Top Left) -->
      <div class="control-panel maintenance-layers" id="layers-panel-maintenance">
        <div class="panel-title">Layers</div>
        <ul id="layerList-maintenance" class="layer-list">
          <li class="layer-item is-on" draggable="true" data-layer="gi-surface-dots">
            <span>GI Distribution</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="gi-surface-dots" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="gi-density-layer">
            <span>Density Map</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="gi-density-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="soils-layer">
            <span>Native Soils</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="soils-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="slope-layer">
            <span>Terrain Slope</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="slope-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="sewer-layer">
            <span>Sewer System</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="sewer-layer" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="drainage-lines">
            <span>Sewer Drainage</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="drainage-lines" min="0" max="100" value="100">
            </div>
          </li>
          <li class="layer-item" draggable="true" data-layer="drainage-points">
            <span>Drainage Points</span>
            <div class="layer-opacity-control">
              <input type="range" class="layer-opacity-slider-maintenance" data-layer="drainage-points" min="0" max="100" value="100">
            </div>
          </li>
        </ul>
      </div>

      <div id="map-scenario" class="map-container-scenario"></div>
      
      <!-- Legend Panel (Lower Left) -->
      <div class="legend-panel" id="asset-legend">
        <div class="legend-title">Selection Status</div>
        <div class="legend-items">
          <div class="legend-row">
            <div class="legend-circle" style="background-color: #0ea5e9; border: 2px solid #0b759e;"></div>
            <span class="legend-text">Unselected</span>
          </div>
          <div class="legend-row">
            <div class="legend-circle" style="background-color: #22c55e; border: 2px solid #15803d;"></div>
            <span class="legend-text">Selected</span>
          </div>
        </div>
      </div>
      
      <!-- Right Side Info Panel -->
      <div id="panel-scenario" class="scenario-panel">
        <section class="block">
          <h2>Selection</h2>
          <div class="row">
            <label class="radio"><input type="radio" name="mode" value="replace" checked /> <span>Replace selection</span></label>
            <label class="radio"><input type="radio" name="mode" value="add" /> <span>Add to selection</span></label>
          </div>
          <label class="label" for="councilSelect">City Council District</label>
          <select id="councilSelect"><option value="">Select‚Ä¶</option></select>
          <label class="label" for="communitySelect">Community District</label>
          <select id="communitySelect"><option value="">Select‚Ä¶</option></select>
          <label class="label" for="assetTypeSelect">Asset Type</label>
          <select id="assetTypeSelect"><option value="">All types‚Ä¶</option></select>
          <small class="muted" style="line-height: 1.4; display: block; margin-top: 6px;">Asset Type highlights rain-garden styles. ‚ÄúROW‚Äù means right-of-way/curbside installs (street bioswales). Leave ‚ÄúAll types‚Ä¶‚Äù to include everything.</small>
          <button id="clearBtn" class="btn secondary">Clear selection</button>
        </section>

        <!-- District Summary Section -->
        <section class="block" id="district-summary-section" style="display: none;">
          <h2>District Overview</h2>
          <div id="district-summary" class="district-summary">
            <!-- District summary will be populated here -->
          </div>
        </section>

        <!-- Asset Conditions Section -->
        <section class="block" id="conditions-section" style="display: none;">
          <h2>Asset Conditions</h2>
          <div id="conditions-summary" class="conditions-summary">
            <!-- Conditions summary will be populated here -->
          </div>
        </section>

        <section class="block">
          <h2>Weeks Without Action</h2>
          <label class="label" for="weeksRange">If maintenance is delayed this many weeks</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <input id="weeksRange" type="range" min="0" max="8" step="1" value="0" style="flex: 1;" />
            <span class="badge" style="white-space: nowrap;"><span id="weeksValue">0</span> weeks</span>
          </div>
          <small class="muted" style="display: block; margin-top: 6px; line-height: 1.5;">
            If maintenance is delayed, performance drops ~10% per week. After 8 weeks, capacity bottoms out at just 20% of potential.
          </small>
          
          <!-- Impact Message -->
          <div id="impact-message-section" style="display: none; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white; border-radius: 8px; padding: 14px; margin-top: 12px;">
            <div id="impact-message-text" style="font-size: 13px; line-height: 1.6; font-weight: 500;"></div>
            <div id="impact-message-value" style="font-size: 24px; font-weight: 700; margin-top: 8px;"></div>
          </div>
        </section>

        <section class="block">
          <h2>If These Gardens Were Maintained‚Ä¶</h2>
          <div class="summary">
            <div><div class="summary-label">Gardens Selected</div><div class="summary-value" id="count">0</div></div>
            <div><div class="summary-label">Stormwater Diverted (gal)</div><div class="summary-value" id="gallons">0</div></div>
            <div><div class="summary-label">Maintenance Needed (hrs/mo)</div><div class="summary-value" id="hours">0</div></div>
            <div><div class="summary-label">Avg Performance Per Garden</div><div class="summary-value" id="avg">0</div></div>
          </div>
          <small class="muted" style="line-height: 1.5; display: block; margin-top: 6px;">
            Performance drops as maintenance is delayed: <strong>capacity = base √ó (1 - 10% √ó weeks)</strong>, bottoming out at <strong>20% of base</strong>.
          </small>
        </section>

        <section class="block">
          <h2>Data &amp; Assumptions</h2>
          <ul class="muted" style="line-height: 1.5; padding-left: 16px; margin: 0;">
            <li>Assets from gi-surface-queens-RG-2025-totals.geojson (Queens GI points only).</li>
            <li>District lookups use NYC City Council and Community District boundaries.</li>
            <li>Base capacity comes from 2025 gallons saved when provided; otherwise from infiltration rate √ó area, or a 6-inch ponding depth fallback.</li>
            <li>Maintenance defaults: ‚â§1000 sq ft ‚Üí ~3 hrs/mo; &gt;1000 sq ft ‚Üí ~4 hrs/mo (unless data provides a value).</li>
            <li>Performance loss: If maintenance is delayed, capacity drops -10% per week, clamped at 20% of base.</li>
          </ul>
        </section>

        <!-- What This Suggests Section -->
        <section class="block" id="insights-section" style="display: none;">
          <h2>What This Suggests</h2>
          <div id="insights-content" style="line-height: 1.6; color: #374151;">
            <!-- Insights will be populated here -->
          </div>
        </section>

        <!-- Feature Info Section -->
        <section class="block">
          <h2>Selected Assets</h2>
          <div id="feature-info" class="feature-info">
            <p class="muted">Select assets on the map to see details</p>
          </div>
        </section>
      </div>
    </section>

  </div>

  <!-- Final: Data & Assumptions -->
  <footer style="margin: 24px auto; max-width: 980px; padding: 16px 20px; border-top: 1px solid #e5e7eb;">
    <h2 style="font-family: 'League Spartan', sans-serif; font-weight: 700; font-size: 18px; margin: 0 0 10px; color: #1f2937;">Data & Assumptions</h2>
    <ul style="margin: 0; padding-left: 18px; line-height: 1.6; color: #374151; font-size: 14px;">
      <li>Assets from gi-surface-queens-RG-2025-totals.geojson (Queens GI points only).</li>
      <li>District lookups use NYC City Council and Community District boundaries.</li>
      <li>Base capacity comes from 2025 gallons saved when provided; otherwise from infiltration rate √ó area, or a 6-inch ponding depth fallback.</li>
      <li>Maintenance defaults: ‚â§1000 sq ft ‚Üí ~3 hrs/mo; &gt;1000 sq ft ‚Üí ~4 hrs/mo (unless data provides a value).</li>
      <li>Performance loss: If maintenance is delayed, capacity drops -10% per week, clamped at 20% of base.</li>
    </ul>
  </footer>

  <script>
    // Landing page background
    document.getElementById('screen-map').style.backgroundImage = "url('rain garden images/stewardship.jpg')";
    document.getElementById('screen-map').style.backgroundSize = "cover";
    document.getElementById('screen-map').style.backgroundPosition = "center";

    // Initialize Mapbox
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3VubmlodSIsImEiOiJjbWQ2bDBwNzcwMThwMm9weTVjc2JuNG90In0.sVXA1xGrFWnG-1ZV_EyO1w';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-73.8298, 40.73],
      zoom: 10.8
    });

    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }));

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    let layersLoaded = false;
    let assetChart = null;

    map.on('load', function() {
      if (layersLoaded) return;
      layersLoaded = true;

      // Add GI surface layer
      map.addSource('gi-surface', {
        type: 'geojson',
        data: 'data/processed/gi-surface-queens-RG-2025-totals.geojson'
      });

      map.addLayer({
        id: 'gi-surface-dots',
        type: 'circle',
        source: 'gi-surface',
        layout: { visibility: 'visible' },
        filter: ['in', ['get', 'asset_type'], ['literal', ['Rain Garden', 'ROWB', 'ROWGS', 'ROWRG', 'ROWSGS']]],
        paint: {
          'circle-radius': ['interpolate', ['linear'], ['get', 'asset_area'], 0, 3, 500, 10],
          'circle-color': [
            'match', ['get', 'asset_type'],
            'Rain Garden', '#17A2B8',
            'ROWRG', '#2ecc71',
            'ROWB', '#FFB366',
            'ROWGS', '#9B59B6',
            'ROWSGS', '#E85D75',
            '#999999'
          ],
          'circle-opacity': 1.0,
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 0.5
        }
      });

      // Add hover popup for GI dots
      map.on('mouseenter', 'gi-surface-dots', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'gi-surface-dots', () => {
        map.getCanvas().style.cursor = '';
      });

      // Create a popup for GI hover info
      const giPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'gi-surface-dots', (e) => {
        const props = e.features[0].properties;
        const assetTypeNames = {
          'Rain Garden': 'Rain Garden',
          'ROWRG': 'Rain Garden in Street',
          'ROWB': 'Bioswale (drainage)',
          'ROWGS': 'Green Street',
          'ROWSGS': 'Stormwater Green Street'
        };
        const friendlyAssetType = assetTypeNames[props.asset_type] || props.asset_type;
        
        let popupHTML = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 12px; max-width: 300px;">
            <b style="font-size: 14px;">${friendlyAssetType}</b><br/>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ccc;">
            <table style="width: 100%; font-size: 11px; line-height: 1.6;">
              <tr><td><b>Asset Type:</b></td><td>${props.asset_type || 'N/A'}</td></tr>
              <tr><td><b>Sewer Type:</b></td><td>${props.sewer_type || 'N/A'}</td></tr>
              <tr><td><b>NYC Waters:</b></td><td>${props.nyc_waters || 'N/A'}</td></tr>
              <tr><td><b>Asset Area:</b></td><td>${Math.round(props.asset_area || 0)} sq ft</td></tr>
              <tr><td><b>Tree (Latin):</b></td><td>${props.tree_latin || 'N/A'}</td></tr>
              <tr><td><b>Program/AR:</b></td><td>${props.program_ar || 'N/A'}</td></tr>
              <tr><td><b>Date Constructed:</b></td><td>${props.date_const || 'N/A'}</td></tr>
            </table>
          </div>
        `;
        
        giPopup.setLngLat(e.lngLat).setHTML(popupHTML).addTo(map);
      });

      map.on('mouseleave', 'gi-surface-dots', () => {
        giPopup.remove();
      });

      // Add Density layer
      map.addSource('gi-density', {
        type: 'geojson',
        data: 'data/processed/gi-surface-density-queens-wgs84-with-counts.geojson'
      });

      map.addLayer({
        id: 'gi-density-layer',
        type: 'fill',
        source: 'gi-density',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': ['step', ['get', 'asset_id_count'], '#fce4ec', 5, '#f8bbd0', 9, '#f48fb1', 13, '#f06292', 17, '#ec407a', 21, '#e91e63', 25, '#d81b60', 29, '#c2185b', 33, '#ad1457', 37, '#880e4f'],
          'fill-opacity': ['case', ['<', ['get', 'asset_id_count'], 3], 0, 1.0]
        }
      });

      map.addLayer({
        id: 'gi-density-outline',
        type: 'line',
        source: 'gi-density',
        layout: { visibility: 'none' },
        paint: { 'line-color': '#ffffff', 'line-width': 0.5, 'line-opacity': 0.15 }
      });

      // Add Soils layer
      map.addSource('soils', {
        type: 'geojson',
        data: 'data/processed/nyc_native_soils_for_rain_gardens.geojson'
      });

      map.addLayer({
        id: 'soils-layer',
        type: 'fill',
        source: 'soils',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': ['match', ['get', 'hsg_native'], 'A', '#1e7145', 'A/D', '#2ecc71', 'B', '#f4d03f', 'B/D', '#f8a028', 'C', '#e67e22', 'C/D', '#d68910', 'D', '#c0392b', '#999999'],
          'fill-opacity': 0.7
        }
      });

      map.addLayer({
        id: 'soils-outline',
        type: 'line',
        source: 'soils',
        layout: { visibility: 'none' },
        paint: { 'line-color': '#ffffff', 'line-width': 0.5, 'line-opacity': 0.3 }
      });

      // Add hover effects for soils layer
      map.on('mouseenter', 'soils-layer', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'soils-layer', () => {
        map.getCanvas().style.cursor = '';
      });

      // Create a popup for soil hover info
      const soilPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'soils-layer', (e) => {
        const props = e.features[0].properties;
        
        // Get infiltration rate description based on HSG
        const infiltrationInfo = {
          'A': 'Excellent (>8 in/hr) - Ideal for rain gardens',
          'A/D': 'Variable - Good when drained',
          'B': 'Good (4-8 in/hr) - Suitable for rain gardens',
          'B/D': 'Variable - Moderate when drained',
          'C': 'Moderate (1-4 in/hr) - Possible with amendments',
          'C/D': 'Variable - Limited when drained',
          'D': 'Poor (<1 in/hr) - Not recommended'
        };

        const infiltrationDesc = infiltrationInfo[props.hsg_native] || 'Unknown';
        
        let popupHTML = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 12px; max-width: 300px;">
            <b style="font-size: 14px;">Native Soil Information</b><br/>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ccc;">
            <table style="width: 100%; font-size: 11px; line-height: 1.6;">
              <tr><td><b>Soil Type:</b></td><td>${props.dominant_soil || 'N/A'}</td></tr>
              <tr><td><b>Soil Symbol:</b></td><td>${props.MUSYM || 'N/A'}</td></tr>
              <tr><td><b>HSG Type:</b></td><td>${props.hsg_native || 'N/A'}</td></tr>
              <tr><td><b>Infiltration:</b></td><td>${infiltrationDesc}</td></tr>
              <tr><td><b>Texture:</b></td><td>${props.texture_group || 'N/A'}</td></tr>
              <tr><td><b>Drainage:</b></td><td>${props.drainage_native || 'N/A'}</td></tr>
            </table>
          </div>
        `;
        
        soilPopup.setLngLat(e.lngLat).setHTML(popupHTML).addTo(map);
      });

      map.on('mouseleave', 'soils-layer', () => {
        soilPopup.remove();
      });

      // Add Slope layer
      map.addSource('slope', {
        type: 'geojson',
        data: 'data/processed/queens-tracts-slope-wgs84.geojson'
      });

      map.addLayer({
        id: 'slope-layer',
        type: 'fill',
        source: 'slope',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': ['step', ['get', 'Slope'], '#f0f8ff', 1.03, '#d4e9f7', 2.06, '#a8d4ed', 3.09, '#7cbde3', 4.12, '#50a8d9', 5.15, '#2493cf', 6.18, '#1578b8', 7.21, '#0f5fa1', 8.24, '#0a468a', 9.27, '#0c2340'],
          'fill-opacity': 1.0
        }
      });

      map.addLayer({
        id: 'slope-outline',
        type: 'line',
        source: 'slope',
        layout: { visibility: 'none' },
        paint: { 'line-color': '#ffffff', 'line-width': 0.5, 'line-opacity': 0 }
      });

      // Slope layer hover interaction
      const slopePopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'slope-layer', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const slope = e.features[0].properties.Slope;
        
        let slopeCategory = '';
        let interpretation = '';
        
        if (slope < 2) {
          slopeCategory = 'Flat terrain';
          interpretation = 'Excellent for water infiltration and rain gardens';
        } else if (slope < 5) {
          slopeCategory = 'Gentle slope';
          interpretation = 'Good for rain gardens with proper design';
        } else if (slope < 8) {
          slopeCategory = 'Moderate slope';
          interpretation = 'May need terracing for rain gardens';
        } else {
          slopeCategory = 'Steep slope';
          interpretation = 'High runoff risk - rain gardens challenging';
        }
        
        const html = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 14px; line-height: 1.6;">
            <strong>Terrain Slope</strong><br>
            <strong>${slope.toFixed(1)}%</strong> - ${slopeCategory}<br>
            <span style="color: #666;">${interpretation}</span>
          </div>
        `;
        
        slopePopup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'slope-layer', () => {
        map.getCanvas().style.cursor = '';
        slopePopup.remove();
      });

      // Add Combined/Separate Sewer layer
      map.addSource('sewer', {
        type: 'geojson',
        data: 'data/processed/combined-sparate%20sewer.geojson'
      });

      map.addLayer({
        id: 'sewer-layer',
        type: 'fill',
        source: 'sewer',
        layout: { visibility: 'visible' },
        paint: {
          'fill-color': [
            'match',
            ['get', 'COMB_OR_SE'],
            'COMBINED', '#2980b9',
            'SEPARAT COMBINED', '#e67e22',
            'DIRECT DRAINAGE', '#27ae60',
            'OTHER', '#8e44ad',
            'UNKNOWN', '#95a5a6',
            '#95a5a6'
          ],
          'fill-opacity': 0.6
        }
      });

      map.addLayer({
        id: 'sewer-outline',
        type: 'line',
        source: 'sewer',
        layout: { visibility: 'visible' },
        paint: { 'line-color': '#ffffff', 'line-width': 0.8, 'line-opacity': 0.4 }
      });

      // Sewer layer hover interaction
      const sewerPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'sewer-layer', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const sewerType = e.features[0].properties.COMB_OR_SE || 'Unknown';
        
        const html = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 14px; line-height: 1.6;">
            <strong>Sewer System</strong><br>
            <strong>${sewerType}</strong>
          </div>
        `;
        
        sewerPopup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'sewer-layer', () => {
        map.getCanvas().style.cursor = '';
        sewerPopup.remove();
      });

      // Add Combined Sewer Drainage layer
      map.addSource('drainage-lines', {
        type: 'geojson',
        data: 'data/processed/combine-sewer-drainage.geojson'
      });

      map.addLayer({
        id: 'drainage-lines',
        type: 'fill',
        source: 'drainage-lines',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': '#ff6b6b',
          'fill-opacity': 0.4
        }
      });

      map.addLayer({
        id: 'drainage-lines-outline',
        type: 'line',
        source: 'drainage-lines',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#cc5555',
          'line-width': 1.5,
          'line-opacity': 0.8
        }
      });

      // Drainage lines hover interaction
      const drainageLinesPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'drainage-lines', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const area = e.features[0].properties.area || 0;
        const acreage = e.features[0].properties.acreage || 0;
        const outfall = e.features[0].properties.outfall || 'Unknown';
        
        const html = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 14px; line-height: 1.6;">
            <strong>Sewer Drainage Area</strong><br>
            <strong>Outfall:</strong> ${outfall}<br>
            <strong>Area:</strong> ${area.toLocaleString()} sq ft<br>
            <strong>Acreage:</strong> ${acreage.toFixed(2)} acres
          </div>
        `;
        
        drainageLinesPopup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'drainage-lines', () => {
        map.getCanvas().style.cursor = '';
        drainageLinesPopup.remove();
      });

      // Add Drainage Points layer
      map.addSource('drainage-points', {
        type: 'geojson',
        data: 'data/processed/drainage points.geojson'
      });

      map.addLayer({
        id: 'drainage-points',
        type: 'circle',
        source: 'drainage-points',
        layout: { visibility: 'none' },
        paint: {
          'circle-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            10, 3,
            15, 8
          ],
          'circle-color': '#4ecdc4',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff',
          'circle-opacity': 0.8
        }
      });

      // Drainage points hover interaction
      const drainagePointsPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: 15
      });

      map.on('mousemove', 'drainage-points', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const outfallType = e.features[0].properties.outfall_ty || 'Unknown';
        const unitId = e.features[0].properties.unitid || 'N/A';
        const ownership = e.features[0].properties.ownership || 'N/A';
        const treatment = e.features[0].properties.treatment || 'N/A';
        
        const html = `
          <div style="font-family: 'League Spartan', sans-serif; font-size: 14px; line-height: 1.6;">
            <strong>Drainage Point</strong><br>
            <strong>ID:</strong> ${unitId}<br>
            <strong>Type:</strong> ${outfallType}<br>
            <strong>Ownership:</strong> ${ownership}<br>
            <strong>Treatment:</strong> ${treatment}
          </div>
        `;
        
        drainagePointsPopup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'drainage-points', () => {
        map.getCanvas().style.cursor = '';
        drainagePointsPopup.remove();
      });

      // Layer management
      const list = document.getElementById('layerList');

      function setLayerVisible(layerId, visible) {
        map.setLayoutProperty(layerId, 'visibility', visible ? 'visible' : 'none');
        if (layerId.includes('outline')) {
          map.setLayoutProperty(layerId, 'visibility', visible ? 'visible' : 'none');
        }
      }

      function applyLayerOrderFromList() {
        const layerNames = Array.from(list.querySelectorAll('.layer-item')).map(item => item.dataset.layer);
        let firstLayer = null;
        for (const layer of map.getStyle().layers) {
          if (layerNames.includes(layer.id)) {
            if (!firstLayer) firstLayer = layer.id;
            if (layer.id !== layerNames[0]) {
              map.moveLayer(layer.id, layerNames[0]);
            }
          }
        }
      }

      function updateLegendDisplay() {
        const activeItems = Array.from(list.querySelectorAll('.layer-item.is-on'));
        const activeLayers = activeItems.map(item => item.dataset.layer);
        
        document.getElementById('gi-modal').classList.toggle('active', activeLayers.includes('gi-surface-dots'));
        document.getElementById('density-modal').classList.toggle('active', activeLayers.includes('gi-density-layer'));
        document.getElementById('soils-modal').classList.toggle('active', activeLayers.includes('soils-layer'));
        document.getElementById('slope-modal').classList.toggle('active', activeLayers.includes('slope-layer'));
        document.getElementById('drainage-lines-modal').classList.toggle('active', activeLayers.includes('drainage-lines'));
        document.getElementById('drainage-points-modal').classList.toggle('active', activeLayers.includes('drainage-points'));
        document.getElementById('sewer-modal')?.classList.toggle('active', activeLayers.includes('sewer-layer'));
        
        if (activeLayers.includes('gi-surface-dots')) {
          setTimeout(() => {
            updateGIAssetStats();
            generateAssetChart();
          }, 100);
        }
      }

      function applyInitialVisibility() {
        const activeItems = Array.from(list.querySelectorAll('.layer-item.is-on'));
        const layerMap = {
          'gi-surface-dots': ['gi-surface-dots'],
          'gi-density-layer': ['gi-density-layer', 'gi-density-outline'],
          'soils-layer': ['soils-layer', 'soils-outline'],
          'slope-layer': ['slope-layer', 'slope-outline'],
          'sewer-layer': ['sewer-layer', 'sewer-outline']
        };

        for (const [dataset, layers] of Object.entries(layerMap)) {
          const isActive = activeItems.some(item => item.dataset.layer === dataset);
          for (const layer of layers) {
            setLayerVisible(layer, isActive);
          }
        }
        updateLegendDisplay();
      }

      function updateGIAssetStats() {
        if (!map.getSource('gi-surface')) return;

        const features = map.querySourceFeatures('gi-surface');
        const stats = {};
        let totalCount = 0;
        
        features.forEach(f => {
          const type = f.properties.asset_type || 'Unknown';
          const area = f.properties.asset_area || 0;
          if (!stats[type]) {
            stats[type] = { count: 0, totalArea: 0 };
          }
          stats[type].count += 1;
          stats[type].totalArea += area;
          totalCount += 1;
        });

        // Update legend header with total asset count
        const legendLabelEl = document.querySelector('#gi-modal .legend-label');
        if (legendLabelEl) {
          legendLabelEl.textContent = `Asset Types ‚Äî ${totalCount.toLocaleString()} assets`;
        }

        // Update legend items: show only types with non-zero share, and show count only
        const assetTypeNames = {
          'Rain Garden': 'Rain Garden',
          'ROWRG': 'Rain Garden in Street',
          'ROWB': 'Bioswale (drainage)',
          'ROWGS': 'Green Street',
          'ROWSGS': 'Stormwater Green Street'
        };
        const legendItems = document.querySelectorAll('#gi-modal .legend-item');
        legendItems.forEach(item => {
          const span = item.querySelector('span');
          const assetType = span.getAttribute('data-type');
          const stat = stats[assetType];
          const pct = totalCount > 0 && stat ? (stat.count / totalCount) * 100 : 0;
          if (!stat || pct === 0) {
            item.style.display = 'none';
          } else {
            const friendlyName = assetTypeNames[assetType] || assetType;
            span.textContent = `${friendlyName}: ${stat.count} assets`;
            item.style.display = '';
          }
        });
      }

      function generateAssetChart() {
        const features = map.querySourceFeatures('gi-surface');
        const stats = {};

        features.forEach(f => {
          const type = f.properties.asset_type || 'Unknown';
          const area = f.properties.asset_area || 0;
          if (!stats[type]) {
            stats[type] = { count: 0, totalArea: 0 };
          }
          stats[type].count += 1;
          stats[type].totalArea += area;
        });

        const sortedTypes = Object.keys(stats).sort((a, b) => stats[b].count - stats[a].count);
        const chartCanvas = document.getElementById('assetChart');
        
        if (assetChart) {
          assetChart.destroy();
        }

        const ctx = chartCanvas.getContext('2d');
        // Compute totals and filter out zero-percent assets
        let totalCount = 0;
        let totalArea = 0;
        sortedTypes.forEach(t => {
          totalCount += stats[t].count;
          totalArea += stats[t].totalArea;
        });

        const filteredTypes = sortedTypes.filter(t => {
          const pct = totalCount > 0 ? (stats[t].count / totalCount) * 100 : 0;
          return pct > 0; // exclude zero-percent
        });

        assetChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: filteredTypes.map(t => t.length > 20 ? t.substring(0, 17) + '...' : t),
            datasets: [{
              label: 'Number of Assets',
              data: filteredTypes.map(t => stats[t].count),
              backgroundColor: '#2ecc71',
              borderColor: '#27ae60',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.8
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.parsed.x + ' assets';
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { font: { size: 10 } },
                grid: { drawBorder: false, color: 'rgba(0,0,0,0.05)' }
              },
              y: {
                ticks: { font: { size: 10 } },
                grid: { display: false }
              }
            }
          }
        });

        // Generate stats table
        const tableHtml = `
          <div class="stats-table-header">
            <div>Asset Type</div>
            <div>Count</div>
            <div>Total Area</div>
          </div>
        `;

        const tableRows = filteredTypes.map(t => {
          return `
            <div class="stats-table-row">
              <div class="stats-type-name">${t}</div>
              <div class="stats-cell">${stats[t].count}</div>
              <div class="stats-cell">${Math.round(stats[t].totalArea).toLocaleString()}</div>
            </div>
          `;
        }).join('');

        document.getElementById('statsTable').innerHTML = tableHtml + tableRows;
      }

      // Layer click handler
      list.addEventListener('click', (e) => {
        const item = e.target.closest('.layer-item');
        if (!item) return;

        item.classList.toggle('is-on');
        const layerId = item.dataset.layer;
        setLayerVisible(layerId, item.classList.contains('is-on'));
        
        const outlineId = layerId.replace('layer', 'outline').replace('-dots', '-outline');
        if (map.getLayer(outlineId)) {
          setLayerVisible(outlineId, item.classList.contains('is-on'));
        }
        
        applyLayerOrderFromList();
        updateLegendDisplay();
      });

      // Drag handlers
      let draggingEl = null;

      function getDragAfterElement(container, y) {
        const elements = [...container.querySelectorAll('.layer-item:not(.dragging)')];
        return elements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          }
          return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      list.addEventListener('dragstart', (e) => {
        const item = e.target.closest('.layer-item');
        if (!item) return;
        draggingEl = item;
        draggingEl.classList.add('dragging');
      });

      list.addEventListener('dragend', () => {
        if (!draggingEl) return;
        draggingEl.classList.remove('dragging');
        draggingEl = null;
        applyLayerOrderFromList();
      });

      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterEl = getDragAfterElement(list, e.clientY);
        if (!draggingEl) return;
        if (afterEl == null) {
          list.appendChild(draggingEl);
        } else {
          list.insertBefore(draggingEl, afterEl);
        }
      });

      // Stats panel toggle
      document.getElementById('stats-toggle').addEventListener('click', function() {
        this.classList.toggle('collapsed');
        document.querySelector('.stats-content').style.display = this.classList.contains('collapsed') ? 'none' : 'block';
      });

      // Initialize
      applyInitialVisibility();
      setTimeout(() => {
        updateGIAssetStats();
        generateAssetChart();
      }, 500);

      // Insight button handlers
      function handleInsightClick(insight, btnElement) {
        // Update button active state
        document.querySelectorAll('.insight-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        btnElement.classList.add('active');

        // Layer mappings for each insight
        const configs = {
          density: {
            show: ['gi-density-layer', 'gi-surface-dots'],
            hide: ['soils-layer', 'slope-layer']
          },
          soils: {
            show: ['soils-layer', 'gi-surface-dots'],
            hide: ['gi-density-layer', 'slope-layer']
          },
          slope: {
            show: ['slope-layer', 'gi-surface-dots'],
            hide: ['gi-density-layer', 'soils-layer']
          }
        };

        const config = configs[insight];
        
        // Turn off hidden layers and outlines
        config.hide.forEach(layer => {
          setLayerVisible(layer, false);
          setLayerVisible(layer + '-outline', false);
        });

        // Turn on visible layers and outlines
        config.show.forEach(layer => {
          if (layer !== 'gi-surface-dots') {
            setLayerVisible(layer + '-outline', true);
          }
          setLayerVisible(layer, true);
        });

        // Update legend display
        updateLegendDisplay();

        // Optional: Zoom to region for density insight
        if (insight === 'density') {
          map.flyTo({
            center: [-73.8298, 40.73],
            zoom: 11,
            duration: 1500
          });
        }
      }

      document.querySelectorAll('.insight-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const insight = this.dataset.insight;
          handleInsightClick(insight, this);
        });
      });
    });

    // Control panel switching (outside map.on('load') so it works immediately)
    document.querySelectorAll('.control-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const panelName = this.dataset.panel;
        const targetPanel = document.getElementById(panelName + '-panel');
        
        if (targetPanel) {
          // Close all other panels
          document.querySelectorAll('.control-panel').forEach(panel => {
            if (panel !== targetPanel) {
              panel.classList.remove('active');
            }
          });
          // Toggle the target panel
          targetPanel.classList.toggle('active');
        }
      });
    });

    // Layer transparency control - individual sliders
    document.querySelectorAll('.layer-opacity-slider').forEach(slider => {
      // Prevent click/mousedown events from triggering layer toggle
      slider.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      slider.addEventListener('mousedown', function(e) {
        e.stopPropagation();
      });
      
      slider.addEventListener('input', function(e) {
        e.stopPropagation(); // Prevent triggering layer toggle
        
        const layerId = this.dataset.layer;
        const opacityPercent = parseInt(this.value);
        const opacityDecimal = opacityPercent / 100;
        
        // Apply opacity based on layer type
        if (map.getLayer(layerId)) {
          if (layerId.includes('dots')) {
            map.setPaintProperty(layerId, 'circle-opacity', opacityDecimal);
          } else if (!layerId.includes('outline')) {
            map.setPaintProperty(layerId, 'fill-opacity', opacityDecimal);
          }
        }
        
        // Also update outline layer if it exists
        const outlineId = layerId.replace('-dots', '-outline').replace('layer', 'outline');
        if (map.getLayer(outlineId)) {
          map.setPaintProperty(outlineId, 'line-opacity', opacityDecimal * 0.3);
        }
      });
    });

    // ===== DISTRICT EXPLORER MAP (Screen 3) =====
    const mapDistrict = new mapboxgl.Map({
      container: 'map-district',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-73.83, 40.75],
      zoom: 11.5,
      accessToken: 'pk.eyJ1IjoibHVjYXNiZXJnbGlhdSIsImEiOiJjbTFibWdnYnQwMzh3MnFzYnM3cWRpN3VsIn0.bDIzJdhB7aTiDLBD5s-xMA'
    });

    mapDistrict.addControl(new mapboxgl.NavigationControl(), 'top-right');

    let selectedDistrict = null;
    let districtLayersLoaded = false;

    mapDistrict.on('load', function() {
      if (districtLayersLoaded) return;
      districtLayersLoaded = true;

      // Add all layers from the main map
      mapDistrict.addSource('gi-surface', {
        type: 'geojson',
        data: 'data/processed/gi-surface-queens-RG-2025-totals.geojson'
      });

      mapDistrict.addLayer({
        id: 'gi-surface-dots',
        type: 'circle',
        source: 'gi-surface',
        layout: { visibility: 'visible' },
        filter: ['in', ['get', 'asset_type'], ['literal', ['Rain Garden', 'ROWB', 'ROWGS', 'ROWRG', 'ROWSGS']]],
        paint: {
          'circle-radius': 4,
          'circle-color': '#2ecc71',
          'circle-stroke-width': 0.5,
          'circle-stroke-color': '#27ae60',
          'circle-opacity': 0.7
        }
      });

      // Add sewer layer
      mapDistrict.addSource('sewer', {
        type: 'geojson',
        data: 'data/processed/combined-sparate%20sewer.geojson'
      });

      mapDistrict.addLayer({
        id: 'sewer-layer',
        type: 'fill',
        source: 'sewer',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': [
            'match',
            ['get', 'COMB_OR_SE'],
            'COMBINED', '#2980b9',
            'SEPARAT COMBINED', '#e67e22',
            'DIRECT DRAINAGE', '#27ae60',
            'OTHER', '#8e44ad',
            'UNKNOWN', '#95a5a6',
            '#95a5a6'
          ],
          'fill-opacity': 0.6
        }
      });

      // Add drainage lines layer
      mapDistrict.addSource('drainage-lines', {
        type: 'geojson',
        data: 'data/processed/combine-sewer-drainage.geojson'
      });

      mapDistrict.addLayer({
        id: 'drainage-lines',
        type: 'fill',
        source: 'drainage-lines',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': '#ff6b6b',
          'fill-opacity': 0.4
        }
      });

      mapDistrict.addLayer({
        id: 'drainage-lines-outline',
        type: 'line',
        source: 'drainage-lines',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#cc5555',
          'line-width': 1.5,
          'line-opacity': 0.8
        }
      });

      // Add drainage points layer
      mapDistrict.addSource('drainage-points', {
        type: 'geojson',
        data: 'data/processed/drainage points.geojson'
      });

      mapDistrict.addLayer({
        id: 'drainage-points',
        type: 'circle',
        source: 'drainage-points',
        layout: { visibility: 'none' },
        paint: {
          'circle-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            10, 3,
            15, 8
          ],
          'circle-color': '#4ecdc4',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff',
          'circle-opacity': 0.8
        }
      });

      // Add soils layer
      mapDistrict.addSource('soils', {
        type: 'geojson',
        data: 'data/processed/rain-gardens/nyc_native_soils_for_rain_gardens.geojson'
      });

      mapDistrict.addLayer({
        id: 'soils-layer',
        type: 'fill',
        source: 'soils',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': [
            'match',
            ['get', 'MUSYM'],
            'BoA', '#8B4513',
            'BoB', '#A0522D',
            'BoC', '#CD853F',
            'BoD', '#DEB887',
            'CeB', '#D2691E',
            'CeC', '#F4A460',
            'ChB', '#DAA520',
            'Pf', '#6B8E23',
            'RaA', '#556B2F',
            'Ud', '#696969',
            '#999'
          ],
          'fill-opacity': 0.6
        }
      });

      // Add slope layer
      mapDistrict.addSource('slope', {
        type: 'geojson',
        data: 'data/processed/queens-tracts-slope-wgs84.geojson'
      });

      mapDistrict.addLayer({
        id: 'slope-layer',
        type: 'fill',
        source: 'slope',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': [
            'step',
            ['get', 'Mean_slope'],
            '#f7fcf5', 0,
            '#e5f5e0', 2,
            '#c7e9c0', 4,
            '#a1d99b', 6,
            '#74c476', 8,
            '#41ab5d', 10,
            '#238b45', 12,
            '#006d2c', 14,
            '#00441b', 16,
            '#003d19', 18
          ],
          'fill-opacity': 0.6
        }
      });

      mapDistrict.addLayer({
        id: 'slope-outline',
        type: 'line',
        source: 'slope',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#006d2c',
          'line-width': 0.5,
          'line-opacity': 0.4
        }
      });

      // Add density layer
      mapDistrict.addSource('gi-density', {
        type: 'geojson',
        data: 'data/processed/gi-surface-density-queens-wgs84-with-counts.geojson'
      });

      mapDistrict.addLayer({
        id: 'density-layer',
        type: 'fill',
        source: 'gi-density',
        layout: { visibility: 'none' },
        paint: {
          'fill-color': [
            'step',
            ['get', 'asset_id_count'],
            '#fce4ec', 0,
            '#f8bbd0', 3,
            '#f48fb1', 6,
            '#f06292', 10,
            '#ec407a', 15,
            '#e91e63', 20,
            '#d81b60', 25,
            '#c2185b', 30,
            '#ad1457', 40,
            '#880e4f', 50
          ],
          'fill-opacity': [
            'case',
            ['<', ['get', 'asset_id_count'], 3],
            0,
            0.7
          ]
        }
      });

      mapDistrict.addLayer({
        id: 'density-outline',
        type: 'line',
        source: 'gi-density',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#880e4f',
          'line-width': 0.5,
          'line-opacity': 0.4
        }
      });

      // Add soils outline
      mapDistrict.addLayer({
        id: 'soils-outline',
        type: 'line',
        source: 'soils',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#8B4513',
          'line-width': 0.5,
          'line-opacity': 0.4
        }
      });

      // Add district boundaries
      mapDistrict.addSource('districts', {
        type: 'geojson',
        data: 'data/processed/queens-council districts-districts.geojson'
      });

      mapDistrict.addLayer({
        id: 'district-boundaries',
        type: 'line',
        source: 'districts',
        paint: {
          'line-color': '#2ecc71',
          'line-width': 2,
          'line-opacity': 0.6
        }
      });

      mapDistrict.addLayer({
        id: 'district-fill',
        type: 'fill',
        source: 'districts',
        paint: {
          'fill-color': 'transparent',
          'fill-opacity': 0
        }
      });

      // District click handler
      mapDistrict.on('click', 'district-fill', (e) => {
        if (e.features.length > 0) {
          const district = e.features[0];
          selectedDistrict = district;
          
          // Show district info
          document.querySelector('.no-selection').style.display = 'none';
          document.getElementById('district-content').style.display = 'block';
          
          // Update district name
          const districtName = district.properties.CounDist || 'Unknown District';
          document.getElementById('district-name').textContent = `Council District ${districtName}`;
          
          // Calculate statistics for the district
          updateDistrictInfo(district);
        }
      });

      // Change cursor on hover
      mapDistrict.on('mouseenter', 'district-fill', () => {
        mapDistrict.getCanvas().style.cursor = 'pointer';
      });

      mapDistrict.on('mouseleave', 'district-fill', () => {
        mapDistrict.getCanvas().style.cursor = '';
      });

      // Layer toggle handlers
      document.querySelectorAll('.district-layer-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
          const layerId = this.dataset.layer;
          const visibility = this.checked ? 'visible' : 'none';
          mapDistrict.setLayoutProperty(layerId, 'visibility', visibility);
          
          // Handle outline layers
          const outlineId = layerId.replace('-layer', '-outline').replace('-dots', '-outline');
          if (mapDistrict.getLayer(outlineId)) {
            mapDistrict.setLayoutProperty(outlineId, 'visibility', visibility);
          }
        });
      });

      // Integrated layers panel opacity sliders
      document.querySelectorAll('.layer-opacity-slider-integrated').forEach(slider => {
        slider.addEventListener('input', function(e) {
          e.stopPropagation();
          
          const layerId = this.dataset.layer;
          const opacityPercent = parseInt(this.value);
          const opacityDecimal = opacityPercent / 100;
          
          // Update the layer visibility and opacity
          if (mapDistrict.getLayer(layerId)) {
            if (layerId.includes('dots') || layerId.includes('points')) {
              mapDistrict.setPaintProperty(layerId, 'circle-opacity', opacityDecimal);
            } else if (!layerId.includes('outline')) {
              mapDistrict.setPaintProperty(layerId, 'fill-opacity', opacityDecimal * 0.6);
            }
          }
          
          // Also update outline layer if it exists
          const outlineId = layerId.replace('-layer', '-outline').replace('density', 'density-outline');
          if (mapDistrict.getLayer(outlineId)) {
            mapDistrict.setPaintProperty(outlineId, 'line-opacity', opacityDecimal * 0.3);
          }
        });
      });

      // Integrated layer list item clicks
      document.querySelectorAll('#layerList-integrated .layer-item').forEach(item => {
        item.addEventListener('click', function() {
          const layerId = this.dataset.layer;
          this.classList.toggle('is-on');
          const visibility = this.classList.contains('is-on') ? 'visible' : 'none';
          
          mapDistrict.setLayoutProperty(layerId, 'visibility', visibility);
          
          // Handle outline layers
          const outlineId = layerId.replace('-layer', '-outline').replace('-dots', '-outline');
          if (mapDistrict.getLayer(outlineId)) {
            mapDistrict.setLayoutProperty(outlineId, 'visibility', visibility);
          }
        });
      });
    });

    function updateDistrictInfo(district) {
      // Get district bounds
      const bounds = new mapboxgl.LngLatBounds();
      const coords = district.geometry.coordinates[0];
      coords.forEach(coord => bounds.extend(coord));
      
      // Zoom to district first
      mapDistrict.fitBounds(bounds, { padding: 50, duration: 1000 });
      
      // Wait for map to render, then query features
      setTimeout(() => {
        // Query GI assets
        const assetFeatures = mapDistrict.queryRenderedFeatures({
          layers: ['gi-surface-dots']
        });
        
        let assetCount = assetFeatures.length;
        let totalArea = 0;
        
        assetFeatures.forEach(f => {
          totalArea += f.properties.asset_area || 0;
        });
        
        // Update asset info
        document.getElementById('district-assets').textContent = assetCount || '0';
        document.getElementById('district-area').textContent = Math.round(totalArea).toLocaleString() + ' sq ft';
        
        // Calculate density (assets per acre)
        const districtAcres = district.properties.Shape_Area ? 
          (district.properties.Shape_Area / 43560).toFixed(2) : 
          'N/A';
        document.getElementById('district-density').textContent = 
          assetCount > 0 && districtAcres !== 'N/A' ? 
          (assetCount / districtAcres).toFixed(2) + ' per acre' : 
          'N/A';
        
        // Query sewer types
        const sewerFeatures = mapDistrict.queryRenderedFeatures({
          layers: ['sewer-layer']
        });
        
        const sewerTypes = new Set();
        sewerFeatures.forEach(f => {
          const type = f.properties.COMB_OR_SE;
          if (type) sewerTypes.add(type);
        });
        
        document.getElementById('district-sewer').textContent = 
          sewerTypes.size > 0 ? 
          Array.from(sewerTypes).join(', ') : 
          'Data not available';
        
        // Query soil types
        const soilFeatures = mapDistrict.queryRenderedFeatures({
          layers: ['soils-layer']
        });
        
        const soilTypes = new Set();
        soilFeatures.forEach(f => {
          const type = f.properties.MUSYM;
          if (type) soilTypes.add(type);
        });
        
        document.getElementById('district-soil').textContent = 
          soilTypes.size > 0 ? 
          soilTypes.size + ' soil types' : 
          'Data not available';
        
        // Query slope ranges
        const slopeFeatures = mapDistrict.queryRenderedFeatures({
          layers: ['slope-layer']
        });
        
        let minSlope = Infinity;
        let maxSlope = -Infinity;
        
        slopeFeatures.forEach(f => {
          const slope = f.properties.Mean_slope;
          if (slope !== null && slope !== undefined) {
            minSlope = Math.min(minSlope, slope);
            maxSlope = Math.max(maxSlope, slope);
          }
        });
        
        document.getElementById('district-slope').textContent = 
          minSlope !== Infinity ? 
          `${minSlope.toFixed(1)}% - ${maxSlope.toFixed(1)}%` : 
          'Data not available';
          
      }, 1000); // Wait for map to finish zooming
    }

    // ===== MAINTENANCE EXPLORER LAYER CONTROLS =====
    // Wait for external map to be ready
    let mapScenarioReady = false;
    const checkMapScenarioInterval = setInterval(() => {
      // Check if mapScenario exists and is fully loaded
      if (typeof mapScenario !== 'undefined' && mapScenario && mapScenario.isStyleLoaded && mapScenario.isStyleLoaded()) {
        clearInterval(checkMapScenarioInterval);
        mapScenarioReady = true;
        initMaintenanceLayerControls();
      }
    }, 100);

    // Fallback: initialize after a delay
    setTimeout(() => {
      if (!mapScenarioReady && typeof mapScenario !== 'undefined' && mapScenario) {
        initMaintenanceLayerControls();
      }
    }, 3000);

    function initMaintenanceLayerControls() {
      // Maintenance layers panel opacity sliders
      document.querySelectorAll('.layer-opacity-slider-maintenance').forEach(slider => {
        slider.addEventListener('input', function(e) {
          e.stopPropagation();
          
          const layerId = this.dataset.layer;
          const opacityPercent = parseInt(this.value);
          const opacityDecimal = opacityPercent / 100;
          
          if (mapScenario && mapScenario.getLayer(layerId)) {
            if (layerId.includes('dots') || layerId.includes('points')) {
              mapScenario.setPaintProperty(layerId, 'circle-opacity', opacityDecimal);
            } else if (!layerId.includes('outline')) {
              mapScenario.setPaintProperty(layerId, 'fill-opacity', opacityDecimal * 0.6);
            }
          }
          
          // Update outline layer if exists
          const outlineId = layerId.replace('-layer', '-outline');
          if (mapScenario && mapScenario.getLayer(outlineId)) {
            mapScenario.setPaintProperty(outlineId, 'line-opacity', opacityDecimal * 0.3);
          }
        });
      });

      // Maintenance layer list item clicks
      document.querySelectorAll('#layerList-maintenance .layer-item').forEach(item => {
        item.addEventListener('click', function() {
          const layerId = this.dataset.layer;
          this.classList.toggle('is-on');
          const visibility = this.classList.contains('is-on') ? 'visible' : 'none';
          
          if (mapScenario && mapScenario.getLayer(layerId)) {
            mapScenario.setLayoutProperty(layerId, 'visibility', visibility);
            
            // Handle outline layers
            const outlineId = layerId.replace('-layer', '-outline');
            if (mapScenario.getLayer(outlineId)) {
              mapScenario.setLayoutProperty(outlineId, 'visibility', visibility);
            }
          }
        });
      });

      // Add hover interactions to display feature info
      addMaintenanceFeatureHovers();
    }

    function addMaintenanceFeatureHovers() {
      if (!mapScenario) return;

      const featureInfoDiv = document.getElementById('feature-info');
      const layersToTrack = ['gi-surface-dots', 'gi-density-layer', 'soils-layer', 'slope-layer', 'sewer-layer', 'drainage-lines', 'drainage-points'];

      layersToTrack.forEach(layerId => {
        if (!mapScenario.getLayer(layerId)) return;

        mapScenario.on('mousemove', layerId, (e) => {
          if (e.features.length > 0) {
            const feature = e.features[0];
            displayFeatureInfo(feature, featureInfoDiv);
          }
        });

        mapScenario.on('mouseleave', layerId, () => {
          featureInfoDiv.innerHTML = '<p class="muted">Hover over features on the map to see details</p>';
        });
      });
    }

    function displayFeatureInfo(feature, infoDiv) {
      const props = feature.properties;
      let html = `<strong>${feature.properties.asset_type || feature.properties.MUSYM || 'Feature'}</strong>`;

      // Add relevant properties based on feature type
      if (props.asset_id) {
        html += `<div class="feature-property"><strong>Asset ID:</strong> <span>${props.asset_id}</span></div>`;
      }
      if (props.asset_area) {
        html += `<div class="feature-property"><strong>Area:</strong> <span>${props.asset_area.toLocaleString()} sq ft</span></div>`;
      }
      if (props.COMB_OR_SE) {
        html += `<div class="feature-property"><strong>Sewer Type:</strong> <span>${props.COMB_OR_SE}</span></div>`;
      }
      if (props.MUSYM) {
        html += `<div class="feature-property"><strong>Soil:</strong> <span>${props.MUSYM}</span></div>`;
      }
      if (props.Mean_slope !== null && props.Mean_slope !== undefined) {
        html += `<div class="feature-property"><strong>Slope:</strong> <span>${props.Mean_slope.toFixed(2)}%</span></div>`;
      }
      if (props.acreage) {
        html += `<div class="feature-property"><strong>Acreage:</strong> <span>${props.acreage.toFixed(2)}</span></div>`;
      }
      if (props.outfall) {
        html += `<div class="feature-property"><strong>Outfall:</strong> <span>${props.outfall}</span></div>`;
      }
      if (props.outfall_ty) {
        html += `<div class="feature-property"><strong>Type:</strong> <span>${props.outfall_ty}</span></div>`;
      }

      infoDiv.innerHTML = html;
    }



  </script>
  <script src="js/index.js"></script>
</body>
</html>
